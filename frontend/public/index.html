<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>‚öñÔ∏è FHE Weight Trend ‚Äî Zama FHEVM</title>
    <style>
      /* ========= Fresh, bright palette (distinct from earlier dark designs) ========= */
      :root{
        --bg:#faf7f2;           /* warm cream */
        --ink:#101729;          /* near-black text */
        --muted:#58627a;        /* slate */
        --card:#ffffff;         /* pure white cards */
        --stroke:#e7e4df;       /* light border */
        --primary:#0ea5a4;      /* teal */
        --primary-2:#22c55e;    /* mint */
        --accent:#8b5cf6;       /* violet */
        --warn:#fb923c;         /* orange */
        --ok:#16a34a;           /* green */
        --bad:#dc2626;          /* red */
        --shadow:0 8px 30px rgba(16,23,41,.08);
      }

      *{margin:0;padding:0;box-sizing:border-box}
      body{
        font-family:"Inter",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        color:var(--ink);
        background:
          radial-gradient(900px 600px at -10% -20%, rgba(142,221,220,.22), transparent 60%),
          radial-gradient(800px 500px at 115% 10%, rgba(229,201,255,.35), transparent 55%),
          repeating-linear-gradient( 90deg, rgba(16,23,41,.03), rgba(16,23,41,.03) 1px, transparent 1px, transparent 18px),
          repeating-linear-gradient(  0deg, rgba(16,23,41,.025), rgba(16,23,41,.025) 1px, transparent 1px, transparent 18px),
          var(--bg);
        min-height:100vh;
      }

      .page{max-width:1080px;margin:0 auto;padding:32px 16px 72px}

      /* ===== Header (minimal) ===== */
      header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px}
      .brand{display:flex;gap:10px;align-items:center}
      .brand h1{font-size:clamp(22px,3.2vw,30px);font-weight:900;letter-spacing:.2px}
      .tag{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:#fff;color:var(--muted);font-weight:700}

      /* ===== Layout: sidebar + main (distinct positioning) ===== */
      .grid{display:grid;grid-template-columns:320px 1fr;gap:18px}
      @media (max-width:980px){.grid{grid-template-columns:1fr}}

      .card{background:var(--card);border:1px solid var(--stroke);border-radius:18px;box-shadow:var(--shadow);padding:18px}
      .card h2{font-size:12px;text-transform:uppercase;letter-spacing:.55px;color:var(--muted);margin-bottom:10px;font-weight:900}

      /* Sidebar cards */
      .side .card:not(:last-child){margin-bottom:18px}
      .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);background:#fff;color:var(--muted);font-weight:800}
      .btn{appearance:none;border:0;cursor:pointer;padding:14px 16px;border-radius:12px;font-weight:900;letter-spacing:.3px;transition:transform .12s ease, box-shadow .18s ease}
      .btn:active{transform:translateY(1px)}
      .btn:disabled{opacity:.55;cursor:not-allowed}
      .b-connect{background:linear-gradient(135deg,#a7f3d0,#86efac);color:#083a2a;box-shadow:var(--shadow)}
      .b-action{background:linear-gradient(135deg,#c7d2fe,#8b5cf6);color:#20183c;box-shadow:var(--shadow)}

      /* Main action card */
      .row{display:grid;grid-template-columns:1fr;gap:12px;margin:10px 0}
      .row-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:10px 0}
      label{display:block;font-size:12px;color:var(--muted);margin:2px 2px 6px}
      input{width:100%;padding:14px;border-radius:12px;border:1px solid var(--stroke);background:#fff;color:var(--ink);font-size:18px;font-weight:800;outline:none;transition:border-color .2s ease, box-shadow .2s ease;text-align:center}
      input:focus{border-color:#c4b5fd;box-shadow:0 0 0 4px rgba(139,92,246,.15)}

      .status{margin:8px 0 6px;padding:10px;border-radius:12px;border:1px dashed var(--stroke);background:#fff;color:var(--muted)}
      .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:4px}

      .result{margin-top:10px;padding:18px;border-radius:14px;border:1px solid var(--stroke);text-align:center;font-weight:900;font-size:22px;background:linear-gradient(180deg,#fff, #fafafa)}
      .good{border-color:#86efac;color:var(--ok);background:linear-gradient(180deg,#ecfdf5,#f6fff9)}
      .bad{border-color:#fecaca;color:var(--bad);background:linear-gradient(180deg,#fff1f2,#fff)}

      footer{margin-top:18px;color:var(--muted);font-size:12px;display:flex;gap:12px;flex-wrap:wrap}
      code{background:#fff;border:1px solid var(--stroke);padding:2px 6px;border-radius:6px;color:#4b5563}
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <div class="brand">
          <span class="tag">ZAMA FHEVM</span>
          <h1>FHE Weight Trend</h1>
        </div>
        <span class="pill">Network: <b>Sepolia</b></span>
      </header>

      <section class="grid">
        <!-- ===== Sidebar ===== -->
        <aside class="side">
          <div class="card">
            <h2>Connect</h2>
            <button id="btnConnect" class="btn b-connect" style="width:100%">üîó Connect Wallet</button>
          </div>

          <div class="card">
            <h2>Contract</h2>
            <div class="row">
              <label>Address</label>
              <input id="ctrAddr" value="0xfbe76c2f2944e73816f23947961a0cbc610bf386" readonly />
            </div>
            <div class="row">
              <label>KMS</label>
              <input id="kmsAddr" value="0x1364cBBf2cDF5032C47d8226a6f6FBD2AFCDacAC" readonly />
            </div>
          </div>

          <div class="card">
            <h2>About</h2>
            <div class="status">
              Encrypt a <b>uint16</b> weight in the browser, submit, and read a public trend only:
              <code>0=‚Üì</code>, <code>1=‚Üí</code>, <code>2=‚Üë</code>. Your exact weight stays private.
            </div>
          </div>
        </aside>

        <!-- ===== Main ===== -->
        <main>
          <div class="card">
            <h2>Submit Weight (Encrypted)</h2>
            <div id="status" class="status">Waiting for connection‚Ä¶</div>

            <div class="row-2">
              <div>
                <label>Current weight (0..65535)</label>
                <input id="weight" type="number" min="0" max="65535" placeholder="e.g., 82" disabled />
              </div>
              <div>
                <label>Units</label>
                <input value="kg (display only)" disabled />
              </div>
            </div>

            <div class="actions">
              <button id="btnSubmit" class="btn b-action" disabled style="min-width:240px">‚ö° Submit & Compare</button>
            </div>

            <div id="trend" class="result hidden">‚Äì</div>
          </div>
        </main>
      </section>

      <footer>
        <div>Contract: <code>0xfbe76c2f2944e73816f23947961a0cbc610bf386</code></div>
        <div>KMS: <code>0x1364cBBf2cDF5032C47d8226a6f6FBD2AFCDacAC</code></div>
      </footer>
    </div>

    <!-- Zama Relayer SDK (official) -->
    <script type="module" crossorigin src="https://cdn.zama.ai/relayer-sdk-js/0.1.2/relayer-sdk-js.js"></script>
    <!-- ethers v6 -->
    <script type="module" crossorigin src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm"></script>

    <script type="module">
      import { BrowserProvider, Contract, getAddress } from "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm";
      import { initSDK, createInstance, SepoliaConfig } from "https://cdn.zama.ai/relayer-sdk-js/0.1.2/relayer-sdk-js.js";

      // ====== Config ======
      const CONTRACT_ADDRESS = "0xfbe76c2f2944e73816f23947961a0cbc610bf386"; // deployed FHEWeightTrend
      const KMS_ADDRESS      = "0x1364cBBf2cDF5032C47d8226a6f6FBD2AFCDacAC";
      const RELAYER_URL      = "https://relayer.testnet.zama.cloud";
      const GATEWAY_URL      = "https://gateway.sepolia.zama.ai/";

      // ====== ABI (only what's used) ======
      const abi = [
        { inputs:[ { name:"weightExt", type:"bytes32" }, { name:"proof", type:"bytes" } ], name:"submitWeight", outputs:[ { name:"", type:"bytes32" } ], stateMutability:"nonpayable", type:"function" },
        { anonymous:false, inputs:[ { indexed:true, name:"user", type:"address" }, { indexed:false, name:"trendHandle", type:"bytes32" } ], name:"WeightSubmitted", type:"event" },
      ];

      // ====== DOM ======
      const $ = (id) => document.getElementById(id);
      const el = { btnConnect: $("btnConnect"), status: $("status"), weight: $("weight"), btnSubmit: $("btnSubmit"), trend: $("trend") };
      let provider, signer, user, contract, relayer;
      const setStatus = (t) => el.status.textContent = t;
      const log = (m) => console.log(`[FHEWeightTrend] ${m}`);
      const showTrend = (code) => {
        const map = { 0: {text: "‚Üì DOWN", cls: "bad"}, 1: {text: "‚Üí SAME", cls: ""}, 2: {text: "‚Üë UP", cls: "good"} };
        const m = map[Number(code)] || { text: String(code), cls: "" };
        el.trend.classList.remove("hidden","good","bad");
        if (m.cls) el.trend.classList.add(m.cls);
        el.trend.textContent = `Trend: ${m.text}`;
      };

      // ====== Connect ======
      async function connect(){
        el.btnConnect.disabled = true;
        try{
          if(!window.ethereum) throw new Error("MetaMask not found");
          const providerRaw = new BrowserProvider(window.ethereum);
          await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: "0xaa36a7" }] });
          await providerRaw.send("eth_requestAccounts", []);
          const s = await providerRaw.getSigner();
          const addr = await s.getAddress();
          const net = await providerRaw.getNetwork();
          if(net.chainId !== 11155111n) throw new Error("Please switch to Sepolia");
          provider = providerRaw; signer = s; user = addr;

          setStatus(`Connected: ${user.slice(0,6)}‚Ä¶${user.slice(-4)}`);
          [el.weight, el.btnSubmit].forEach(x => x.disabled = false);

          // Init Relayer SDK
          await initSDK();
          const relayerCfg = { ...SepoliaConfig, network: window.ethereum, relayerUrl: RELAYER_URL, gatewayUrl: GATEWAY_URL, debug: true };
          const kmsCode = await provider.getCode(KMS_ADDRESS); if(kmsCode === "0x") throw new Error("KMS not found");
          const ctrCode = await provider.getCode(CONTRACT_ADDRESS); if(ctrCode === "0x") throw new Error("Contract not found");
          relayer = await createInstance(relayerCfg);
          log("Relayer ready ‚úÖ");

          // Contract
          contract = new Contract(CONTRACT_ADDRESS, abi, signer);
          log(`Contract initialized: ${CONTRACT_ADDRESS}`);
        }catch(e){ setStatus(`‚ùå ${e.message}`); log(`connect error: ${e?.message||e}`); el.btnConnect.disabled=false; }
      }
      el.btnConnect.addEventListener("click", connect);
      if(window.ethereum){ window.ethereum.on?.("chainChanged",()=>window.location.reload()); window.ethereum.on?.("accountsChanged",()=>window.location.reload()); }

      // ====== Encrypt & Submit ======
      el.btnSubmit.addEventListener("click", async () => {
        try{
          if(!signer || !relayer || !contract) throw new Error("Connect wallet first");
          const w = parseInt(el.weight.value);
          if(!(w >= 0 && w <= 65535)) throw new Error("Weight must be 0..65535");

          el.btnSubmit.disabled = true; setStatus("Encrypting & sending‚Ä¶"); el.trend.classList.add("hidden");

          // Encrypt euint16
          const buf = relayer.createEncryptedInput(getAddress(CONTRACT_ADDRESS), getAddress(user));
          if(typeof buf.add16 !== "function") throw new Error("SDK: add16() not available");
          buf.add16(BigInt(w));
          const { handles, inputProof } = await buf.encrypt();
          const weightExt = handles[0];
          const proof = inputProof;
          log(`Encrypted weight ‚Üí handle=${typeof weightExt === 'string' ? weightExt : '(bytes)'}; proofLen=${(proof?.length)||0}`);

          const tx = await contract.submitWeight(weightExt, proof, { gasLimit: 1_000_000 });
          log(`txHash: ${tx.hash}`);
          const receipt = await tx.wait();

          let trendHandle;
          for(const lg of receipt.logs){
            try{ const p = contract.interface.parseLog(lg); if(p && p.name === "WeightSubmitted"){ trendHandle = p.args.trendHandle; break; } }catch{}
          }
          if(!trendHandle) throw new Error("Trend handle not found in receipt");

          const out = await relayer.publicDecrypt([trendHandle]);
          const code = Array.isArray(out) ? out[0] : (out[trendHandle] ?? out[String(trendHandle)]);
          const n = (typeof code === 'bigint') ? Number(code) : Number(code||0);
          showTrend(n);
          setStatus("‚úÖ Done");
        }catch(e){ setStatus(`‚ùå ${e.message}`); log(`submit error: ${e?.message||e}`); }
        finally{ el.btnSubmit.disabled = false; }
      });
    </script>
  </body>
</html>
